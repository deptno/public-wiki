- [[github-action]] [[../self-hosted|self-hosted]] runner
  - dind(docker in docker mode) 와 kuberentes 모드가있는데 귀찮아서 dind모드로 함
    - dind가 아니면 job이 뜨는 컨테이너가 [[../docker|docker]] 를 빌드하기 위한 추가 작업 필요
  - [X] 풀어야할 숙제
    - [X] [[../kubectl|kubectl]]
      - runner 에 권한을 부여해야함, [[../kyverno]] 를 사용하여 해당 namespace 의 파드에 권한 부여
        ```yaml
        apiVersion: kyverno.io/v1
        kind: ClusterPolicy
        metadata:
          name: arc-job-attach-serviceaccount
        spec:
          background: false
          rules:
            - name: add-sa-to-arc-jobs
              match:
                resources:
                  kinds:
                    - Pod
                  namespaces:
                    - arc-runners
                  selector:
                    matchLabels:
                      actions.github.com/scale-set-name: arc-runner-set
              mutate:
                patchStrategicMerge:
                  spec:
                    serviceAccountName: arc-runner-sa
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRole
        metadata:
          name: arc-runner-deployer
        rules:
          - apiGroups: ["apps", "extensions"]
            resources:
              - deployments
              - statefulsets
              - daemonsets
              - replicasets
            verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
          - apiGroups: [""]
            resources:
              - pods
              - services
              - configmaps
              - secrets
              - namespaces
            verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
          - apiGroups: ["networking.k8s.io"]
            resources:
              - ingresses
            verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
          - apiGroups: [""]
            resources:
              - events
            verbs:
              - get
              - list
              - watch
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: arc-runner-deployer-binding
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: arc-runner-deployer
        subjects:
          - kind: ServiceAccount
            name: arc-runner-sa
            namespace: arc-runners
        ```
    - [X] [[../docker|docker]] private registry 사용
      + [[../harbor|harbor]]
      - [X] [[../helm|helm]] ghr-runner-scale-set@0.12.1 기준 설정
        ```yaml
        template:
          spec:
            serviceAccountName: arc-runner-sa
            imagePullSecrets:
              - name: harbor-bot # 이건 runner 컨테이너 자체가 harbor 로 부터 올때를 위해
            initContainers:
            ...
            containers:
            - name: runner
              ...
              # dockerconfigjson 을 주입하여 harbor 인증 처리, docker pull 가능
              volumeMounts:
                - name: harbor-bot-dockerconfig
                  mountPath: /home/runner/.docker
                  readOnly: true
            volumes:
            - name: harbor-bot-dockerconfig
              secret:
                secretName: harbor-bot
                defaultMode: 0644
                items:
                  - key: .dockerconfigjson
                    path: config.json
        ```
  - 이를 실행하는 [[../github-action|github-action]] workflow
```yaml
name: Simple Run Log

on:
  pull_request:

jobs:
  registry-access-check:
    runs-on: arc-runner-set
    steps:
      - name: Pull crawler image from harbor
        run: docker pull harbor.xxx/xxx/xxx:latest
  kubectl-check:
    runs-on: arc-runner-set
    steps:
      - name: Install kubectl
        run: |
          mkdir -p $HOME/bin
          curl -LO "https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH
      - name: List pods
        run: kubectl get pods -A
```
