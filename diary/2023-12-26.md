- [ ] react-query f/u
- [ ] 빌드
  - [[../ios|ios]]
    - [[../apple|apple]] developer 등록없이 배포 불가
      - 승인 대기중
      - 9시간 정도 이후 이메일 옴
      - 프로그램 사용권 계약에 대해 검토 
      - 프로비저닝 프로파일은 다음을 포함있다
        - 개발자의 인증서(애플을 통해 인증되었기 때문에 폰에서 신뢰하기를 누르는 절차가 생략된다)
        - 앱의 bundle id
        - device uuid
      - 기본적으로 개발자 인증서가 하나 발급되어있다. developer.apple.com 에서는 확인하지 못했으나 xcworkspace 를 열어서보면 확인된다
        - *Signing & Capabiliteis* -> *Signing* -> *Team* 에 보면 추가되어있는 것을 확인할 수 있다
        - 선택을 하게되면 *identifiers* 리스트에 추가된 것을 확인할 수 있다
          + https://developer.apple.com/account/resources/identifiers/list
        - Product -> Archive 해본다
          - [X] 이제 Validate 진행된다
          - [X] Release Testing
            - `xcarchive` 파일이 `/Users/[USER_NAME]/Library/Developer/Xcode/Archives/[DATE]` 쪽에 저장
            - 지정한 경로로 `ipa` 파일 생성
          - [ ] Testflight Internal Only
          - [ ] Testflight & Appstore
        - [ ] Product -> Edit Schema -> Release -> Run 하게도면 디바이스 미등록 메시지가 나오고 등록을 눌러준다
          - https://developer.apple.com/account/resources/devices/list 에 추가되는 것 확인
          - 설치 실패
          - `Failed to install the app on the device.`
            - `Command Ld emitted errors but did not return a nonzero exit code to indicate failure`
            - `IDERunOperationFailingWorker = IDEInstallCoreDeviceWorker;`
            - Team 선택에서 앱스토어가 아닌 개발자 등록 이전에 쓰던 것으로는 사용가능
            - 아마도 인증서가 바뀐경우 설치된 디바이스에서 제거를 수동으로 해줘야해서 발생하는 것으로 보인다
              + https://developer.apple.com/forums/thread/739711 pod 지우고 다시 설치하라는 글도 있다

      - test flight setup
    - [[../fastlane|fastlane]] setup
      - system 으로 설치하는게 맞을수도 있을 것은 같은데 공식 문서에서 추천하지 않아서 ~~brew 설치~~ 하려했으나 [[../react-native|react-native]] 프로젝트 루트에 있는 `Gemfile` 에 `gem 'fastlane'` 을 추가하여 `bundle install` 을 통해 설치
        ```sh 
        cd android
        bundle exec fastlane init # 대충 기본만 하고 나머진 모두 생략 supply 도 하지 않음, fastlane/{AppFile,FastFile} 이 생성됨
        bundle exec fastlane test # fastlane/README.md 가 지금 생성됨
        ```
      - `fastlane` 파일을 열어보면 `lane` 이 있어서 `bundle exec fastlane beta` 테스트
      - `crashlytics` 에러가 발생 아무래도 [[../firebase|firebase]] 서비스를 이야기하는것 같은데 구글 계정 설정을 안해서 나는 것으로 보인다 이것부터 설정
        ```sh 
        bundle exec fastlane [android] beta
        [05:46:33]: fastlane finished with errors

        [!] Could not find action, lane or variable 'crashlytics'. Check out the documentation for more details: https://docs.fastlane.tools/actions
        ```
      - 주석처리하고 firebase app distribution 추가
        + https://firebase.google.com/docs/app-distribution/ios/distribute-fastlane?hl=ko
        ```sh 
        fastlane add_plugin firebase_app_distribution
        ```
      - 계정 정보 추가
        + https://docs.fastlane.tools/actions/supply/
        - *구글 클라우드 콘솔*에서 *Google Play Android Developer API* 활성화
        - *구글 클라우드 콘솔*에서 *Service Account* 생성
          - fastlane-supply 와 같은 알아보기 쉬운 이름,  이메일은 생성기 돌릴 것 -> **DONE**
        - 생성된 계정의 메뉴로 들어가 `Manage keys` 선택
          - ADD KEY -> Create New Key(JSON)
        - *구글 플레이 콘솔*에서 *Users and Permissions* 진입
          - Invite new users -> 위에서 생성한 서비스 어카운트 이메일 입력 -> Account Permissions 에서 admin 권한 후 초대
        ```sh
        bundle exec fastlane run validate_play_store_json_key json_key:[아까 다운로드 받은.json]
        ```
        - 성공 확인되면 AppFile `json_key_file("[아까 다운로드 받은.json]")` 로 수정
        - 이것으로 `crashlytics` 에러가 해결되지는 않음
        - `fastlane supply init` 
          - `[!] Google Api Error: Invalid request - Package not found: [package.name].` 에러가 발생
            - *구글 플레이 콘솔*  에서 앱을 아직 생성하지 않았고 한번은 업로드해야한다는 글들이 있음
              + https://stackoverflow.com/questions/69073389/fastlane-google-api-error-invalid-request-package-not-found-com-example
            - [[../wip|wip]]

    - ~~일반> 프로파일 및 기기관리 > 개발자앱> 개발자를 신뢰함> 신뢰~~
      - 일반 > VPN 및 기기 관리 -> VPN 쪽으로 이동한 것으로 추측됨
  - [[../android|android]]
      - `keytool -genkeypair -v -storetype PKCS12 -keystore my-upload-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000`
- [X] [[../apple|apple]] 개발자 계정 결재
- [X] android package.name 변경

- releaes 빌드를 위해 `build.properties` 에 `*.keystore` 파일에 대한 정보를 패스워드 포함해서 주입이 필요함
  ```sh 
  > Task :app:packageRelease FAILED

  FAILURE: Build failed with an exception.

  * What went wrong:
  Execution failed for task ':app:packageRelease'.
  > A failure occurred while executing com.android.build.gradle.tasks.PackageAndroidArtifact$IncrementalSplitterRunnable
     > SigningConfig "release" is missing required property "storeFile".
  ```
  - `gradle.properties` 에 선언한다,  참조하는 fastlane 과 페어로 동작
  ```sh 
  MYAPP_UPLOAD_STORE_FILE=release.keystore
  MYAPP_UPLOAD_KEY_ALIAS=release
  MYAPP_UPLOAD_STORE_PASSWORD=********
  MYAPP_UPLOAD_KEY_PASSWORD=********
  ```

- proguard
| option                    |      MB |
|---------------------------|--------:|
| debug                     |  150.91 |
| release                   |   53.16 |
| release+proguard          |   49.86 |
| release+splitted          |  max 20 |
| release+proguard+splitted |  max 17 |
