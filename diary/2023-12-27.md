- [ ] [[ios]] [[testflight]]
- [ ] [[firebase]] crashlytics
- [ ] [[fastlane]]
  - [ ] firebase-app-distribution
    - [ ] ios
      ```sh 
      Missing authentication credentials. Set up Application Default Credentials, your Firebase refresh token, or sign in with the Firebase CLI, and try again.
      ```
      - `fastlane/FastFile` 에서 인자로 인증키 위치 입력
        ```sh 
        the server responded with status 403
        ```
        + ~~https://stackoverflow.com/a/77438947~~
        + https://stackoverflow.com/questions/62385911/firebase-app-distribution-failed-to-fetch-app-information-403-the-caller-do
      - 구글 클라우드 콘솔 ->  프로젝트 ->  IAM -> 서비스계정에 firebase 배포에 사용되는 계정 이메일 선택 -> **Firebase 앱 배포** role 추가
        ```sh 
        the server responded with status 404
        ```
        - firebase console -> Release & Monitor 에서 서비스가 시작된 것인지 확인(대시보드가 보여야함)
          - android / ios 를 **별도로 설정**해야하니 이 부분에 유의
      - 메일도 오고 테스트도 등록되었으나 다운로드 불가 
        ```txt 
        기기가등록되었으며이제준비가끝났습니다
        앱을테스트할준비가되면이메일이전송됩니다.
        ```
        + https://firebase.google.com/codelabs/appdistribution-udid-collection?hl=ko#2
          ```sh 
          [14:00:01]: ------------------------------
          [14:00:01]: --- Step: default_platform ---
          [14:00:01]: ------------------------------
          [14:00:01]: ----------------------------------------------
          [14:00:01]: --- Step: git log -1 --oneline | tr -d '
          ' ---
          [14:00:01]: ----------------------------------------------
          [14:00:01]: $ git log -1 --oneline | tr -d '
          '
          [14:00:01]: ▸ 8e0f3c19 fastlane: firebase 배포시에 테스터 그룹 지정
          [14:00:01]: Driving the lane 'ios firebase' 🚀
          [14:00:01]: ------------------------------
          [14:00:01]: --- Step: get_certificates ---
          [14:00:01]: ------------------------------

          +-----------------------------------------------------------------------------+
          |                          Summary for cert 2.217.0                           |
          +-------------------------+---------------------------------------------------+
          | development             | false                                             |
          | force                   | false                                             |
          | generate_apple_certs    | true                                              |
          | username                | deptno@gmail.com                                  |
          | team_id                 | xxxxxxxxxx                                        |
          | keychain_path           | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
          | skip_set_partition_list | false                                             |
          | platform                | ios                                               |
          +-------------------------+---------------------------------------------------+

          [14:00:01]: Starting login with user 'deptno@gmail.com'
          -------------------------------------------------------------------------------------
          Please provide your Apple Developer Program account credentials
          The login information you enter will be stored in your macOS Keychain
          You can also pass the password using the `FASTLANE_PASSWORD` environment variable
          See more information about it on GitHub: https://github.com/fastlane/fastlane/tree/master/credentials_manager
          -------------------------------------------------------------------------------------
          Password (for deptno@gmail.com): ***********
          security: SecKeychainAddInternetPassword <NULL>: The specified item already exists in the keychain.
          Could not store password in keychain
          Available session is not valid any more. Continuing with normal login.
          [14:00:10]: Successfully logged in
          [14:00:11]: Found the certificate xxxxxxxxxx (Bonggyun Lee) which is installed on the local machine. Using this one.
          [14:00:11]: Verifying the certificate is properly installed locally...
          [14:00:11]: Successfully installed certificate xxxxxxxxxx
          [14:00:11]: Use signing certificate 'xxxxxxxxxx' from now on!
          ```
          + https://developer.apple.com
          - 인증서 생성된 것 확인 가능 TYPE: **Distribution**
          - 프로파일 생성된 것 확인 가능 TYPE: **Ad hoc**
          - 이후 배포되는 것들에대해서는 다운로드 확인됨
          - 추가적인 디바이스가 필요한 경우에는 디바이스 추가해서 진행
          - [ ] 여러 기기에서 빌드가 필요한 경우에는 [[match]] 필요
        - [[../udid|udid]] 등록확인
  - [[../ios|ios]]
    ```sh 
    bundle exec fastlane init
    ```
    - **Automate beta distribution to TestFlight** 선택
    - 문서 `Podfile` 에 UTF-8 설정을 요구하고 있음
    ```ruby 
    export LC_ALL=en_US.UTF-8
    export LANG=en_US.UTF-8
    ```
      + https://docs.fastlane.tools/getting-started/ios/setup/
  - [ ] 인증
    - *App Store Connect API Key* 를 권장하나 fastlane 에서 `produce`, `pem` action 혹은 tool 을 지원하지 못한다
      + https://appstoreconnect.apple.com/access/api
      - *App Store Connect API 액세스 요청*  -> 바로 승인됨
      - *API 키 생성* role 은 **앱 관리** 로 줘봄
        ```sh 
        [01:36:03]: ✅  Logging in with your Apple ID was successful
        [01:36:03]: Checking if the app '[BUNDLE_ID]' exists in your Apple Developer Portal...
        [01:36:04]: ✅  Your app '[BUNDLE_ID]' is available in your Apple Developer Portal
        [01:36:04]: Checking if the app '[BUNDLE_ID]' exists on App Store Connect...
        [01:36:04]: Looks like the app '[BUNDLE_ID]' isn't available on App Store Connect
        [01:36:04]: for the team ID '126815971' on Apple ID 'deptno@gmail.com'
        [01:36:04]: Would you like fastlane to create the App on App Store Connect for you? (y/n)
        ```
      - 생성해주기도 하는데 직접생성하기로한다
        - SKU 는 고유 아이디로 노출되지 않는다 `AAAA_0001` 이런식으로 생성이 가능
      - 앱생성후에 `fastlane init` 을 이어가면 `Gemfile`과 함께 `fastlane/{App,Fast}File` 이 생성된다
      - `bundle exec fastlane beta` achive 이 후 에러가 발생
        ```sh 
        [02:04:08]: ▸ Archive Succeeded
        # ...
        error: exportArchive: No profiles for '[BUNDLE_ID]' were found

        Error Domain=IDEProfileLocatorErrorDomain Code=1 "No profiles for '[BUNDLE_ID]' were found" UserInfo={IDEDistributionIssueSeverity=3, NSLocalizedDescription=No profiles for '[BUNDLE_ID]' were found, NSLocalizedRecoverySuggestion=Xcode couldn't find any iOS App Store provisioning profiles matching '[BUNDLE_ID]'. Automatic signing is disabled and unable to generate a profile. To enable automatic signing, pass -allowProvisioningUpdates to xcodebuild.}

        ** EXPORT FAILED **
        [02:04:19]: Exit status: 70

        # ...

        [02:04:20]: fastlane finished with errors

        [!] Error packaging up the application
        ```
        - **Provisioning Profile** 이 없어서 나는 에러로 디펄로퍼 콘솔에서 생성하면된다 **개발목적과 배포목적이 따로 필요**한데 여기선 testflight **배포** 목적이니 **Ad Hoc** 으로 생성
          - [ ] 생성 후 *Automatically manage signing* 을 체크 해제하고 *Download Profile* 을 선택해서 방금 생성한 프로파일을 선택
          - [X] 수동은 알아만 두고 자동으로한다
        - *App Store Connect API Key*를 lane 안에 추가
          ```sh 
          api_key = app_store_connect_api_key(
            key_id: "[API KEY ID]",
            issuer_id: "[API KEY ISSUER]",
            key_filepath: "./[생성한 API KEY].p8",
            duration: 1200, # optional (maximum 1200)
            in_house: false # optional but may be required if using match/sigh
          )
          ```
        - 빌드 후 icon 에러
          ```sh 
          [04:02:20]: [altool] 2023-12-27 04:02:20.553 *** Error: Asset validation failed Missing required icon file. The bundle does not contain an app icon for iPhone / iPod Touch of exactly '120x120' pixels, in .png format for iOS versions >= 10.0. To support older versions of iOS, the icon may be required in the bundle outside of an asset catalog. Make sure the Info.plist file includes appropriate entries referencing the file. See https://developer.apple.com/documentation/bundleresources/information_property_list/user_interface (ID: e19b1052-837f-4d5a-b7a2-98a288cc04e5) (90022)
          [04:02:20]: [altool]  {
          [04:02:20]: [altool]     NSLocalizedDescription = "Asset validation failed";
          [04:02:20]: [altool]     NSLocalizedFailureReason = "Missing required icon file. The bundle does not contain an app icon for iPhone / iPod Touch of exactly '120x120' pixels, in .png format for iOS versions >= 10.0. To support older versions of iOS, the icon may be required in the bundle outside of an asset catalog. Make sure the Info.plist file includes appropriate entries referencing the file. See https://developer.apple.com/documentation/bundleresources/information_property_list/user_interface (ID: e19b1052-837f-4d5a-b7a2-98a288cc04e5)";
          [04:02:20]: [altool]     NSUnderlyingError = "Error Domain=IrisAPI Code=-19241 \"Asset validation failed\" UserInfo={status=409, detail=Missing required icon file. The bundle does not contain an app icon for iPhone / iPod Touch of exactly '120x120' pixels, in .png format for iOS versions >= 10.0. To support older versions of iOS, the icon may be required in the bundle outside of an asset catalog. Make sure the Info.plist file includes appropriate entries referencing the file. See https://developer.apple.com/documentation/bundleresources/information_property_list/user_interface, id=e19b1052-837f-4d5a-b7a2-98a288cc04e5, code=STATE_ERROR.VALIDATION_ERROR.90022, title=Asset validation failed, NSLocalizedFailureReason=Missing required icon file. The bundle does not contain an app icon for iPhone / iPod Touch of exactly '120x120' pixels, in .png format for iOS versions >= 10.0. To support older versions of iOS, the icon may be required in the bundle outside of an asset catalog. Make sure the Info.plist file includes appropriate entries referencing the file. See https://developer.apple.com/documentation/bundleresources/information_property_list/user_interface, NSLocalizedDescription=Asset validation failed}";
          [04:02:20]: [altool]     "iris-code" = "STATE_ERROR.VALIDATION_ERROR.90022";
          [04:02:20]: [altool] }

          [04:02:20]: Application Loader output above ^
          [04:02:20]: ERROR: [ContentDelivery.Uploader] Asset validation failed (90713) Missing Info.plist value. A value for the Info.plist key 'CFBundleIconName' is missing in the bundle 'ro.salji.app'. Apps built with iOS 11 or later SDK must supply app icons in an asset catalog and must also provide a value for this Info.plist key. For more information see http://help.apple.com/xcode/mac/current/#/dev10510b1f7. (ID: 88fadd26-4d5d-475c-a298-7a3ac144d52a)
          ```          
      - 아이콘 주입 testflight 에 올라간 것은 확인 되나 에러
        - `No build_beta_detail included`
      - appstoreconnect -> TestFlight -> 베타 정보 입력
      - 이후 성공

- appstoreconnect
  - [X] 내부 테스팅 그룹 생성
- firebase app distribution
  - [X] 테스팅 그룹 생성

- fastlane 버저닝이 xcodeproj 를 기준으로 하면서 파일이 계속 변경되어 커밋해야하는 이슈가 있음
  - *SharedValues* 조사
  - 빌드 번호 형식 조사
